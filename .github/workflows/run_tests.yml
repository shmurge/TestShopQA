name: Automated UI tests

on:
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Choose target'
        required: true
        default: 'chrome-browser'
        type: choice
        options:
          - chrome-browser
          - firefox-browser

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  download-history:
    runs-on: ubuntu-latest
    name: Download Allure report history
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          # Получаем ID артефакта allure_report
          ARTIFACT_ID=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.CI_TOKEN }}" \
            "https://api.github.com/repos/shmurge/TestShopQA/actions/artifacts?name=allure_report" | \
            python3 -c "import sys, json; data = json.load(sys.stdin); print(data['artifacts'][0]['id']) if data['artifacts'] else print('')")
          
          if [ -n "$ARTIFACT_ID" ]; then
            curl -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.CI_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/shmurge/TestShopQA/actions/artifacts/$ARTIFACT_ID/zip" -o artifacts.zip
            mkdir -p allure_report && unzip -o artifacts.zip -d allure_report || true
          fi

          # Получаем ID артефакта github-pages
          REPORT_ID=$(curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.CI_TOKEN }}" \
            "https://api.github.com/repos/shmurge/TestShopQA/actions/artifacts?name=github-pages" | \
            python3 -c "import sys, json; data = json.load(sys.stdin); print(data['artifacts'][0]['id']) if data['artifacts'] else print('')")
          
          if [ -n "$REPORT_ID" ]; then
            curl -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.CI_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/shmurge/TestShopQA/actions/artifacts/$REPORT_ID/zip" -o pages.zip
            mkdir -p old_pages pages_history && unzip -o pages.zip -d old_pages && tar -xvf old_pages/artifact.tar -C pages_history || true
            mkdir -p allure_report/history
            cp -r pages_history/history/* allure_report/history/ || true
          fi
        continue-on-error: true
      - name: Upload allure history
        uses: actions/upload-artifact@v4
        with:
          name: allure_report
          path: allure_report
          retention-days: 3

  test-run:
    name: Test run
    runs-on: ubuntu-latest
    needs: download-history
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Chrome
        if: github.event.inputs.deployment_target == 'chrome-browser'
        run: sudo apt-get install -y google-chrome-stable
      - name: Install Firefox
        if: github.event.inputs.deployment_target == 'firefox-browser'
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4
      - name: Get variables
        run: |
          echo "USERNAME=${{ secrets.USERNAME }}" >> $GITHUB_ENV
          echo "LOGIN=${{ secrets.LOGIN }}" >> $GITHUB_ENV
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> $GITHUB_ENV
      - name: run-in-chrome-browser
        if: github.event.inputs.deployment_target == 'chrome-browser'
        run: pytest -vs --tb=line --headless -n=5 --reruns=3 --alluredir=allure_report
        continue-on-error: true
      - name: run-in-firefox-browser
        if: github.event.inputs.deployment_target == 'firefox-browser'
        run: pytest -vs --tb=line --headless --browser=firefox -n=5 --reruns=3 --github_actions --alluredir=allure_report
        continue-on-error: true
      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure_report
          path: allure_report
          retention-days: 3
          overwrite: true

  generate-allure-report:
    name: Generate Allure report
    runs-on: ubuntu-latest
    needs: test-run
    steps:
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - run: |
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.32.0/allure-2.32.0.tgz 
          sudo tar -zxvf allure-2.32.0.tgz -C /opt/ 
          sudo ln -sf /opt/allure-2.32.0/bin/allure /usr/bin/allure
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4
      - run: allure generate -c allure_report -o _site
      - name: Upload generated Allure report
        uses: actions/upload-artifact@v4
        with:
          name: _site
          path: _site
          retention-days: 3

  publish-allure-report:
    name: Publication allure-report
    runs-on: ubuntu-latest
    needs: generate-allure-report
    steps:
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
      - name: Deploy to Github pages
        uses: actions/deploy-pages@v4
